<!DOCTYPE html>
<meta charset="utf-8">
<style>
  .link {
    stroke: gray;
    stroke-width: .8px;
  }

  .node {
    fill: white;
    stroke: #FFF;
    stroke-width: .9px;
  }

  .shell:hover {
    stroke: #000;
    stroke-width: 2px;
  }

.node.fixed {
  fill: #f00;
}
</style>
<body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

var newsfeed = '<path fill="#00BDD1" d="M384.163,699.913H1.753V1.754h382.41V699.913z M385.916,0H0v701.666h385.916V0z"/> <rect y="0.876" fill="#00BDD1" width="385.916" height="61.396"/> <rect x="149.104" y="14.033" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" width="87.709" height="35.083"/> <rect x="17.542" y="18.419" fill="#FFFFFF" width="35.083" height="5.262"/> <rect x="17.542" y="28.944" fill="#FFFFFF" width="35.083" height="5.262"/> <rect x="17.542" y="39.469" fill="#FFFFFF" width="35.083" height="5.262"/> <line fill="#00BDD1" x1="194.835" y1="14.618" x2="194.835" y2="48.532"/> <line fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" x1="194.835" y1="14.618" x2="194.835" y2="48.532"/> <rect x="333.291" y="15.438" fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" width="35.083" height="32.208"/> <path fill="#FFFFFF" d="M166.099,44.64c-8.272,0-10.616-1.179-11.201-1.556c0.072-1.179,0.22-2.568,0.403-3.2 c0.291-0.925,0.621-1.303,1.061-1.682c0.22-0.169,1.683-0.8,2.671-1.222c1.502-0.631,3.075-1.303,3.699-1.724 c0.768-0.505,1.609-2.484,1.279-3.491c-0.075-0.295-0.256-0.549-0.512-0.843c-0.548-0.675-1.242-1.978-1.537-3.24 c-0.402-1.768-0.732-5.303,0.621-7.449c0.732-1.136,1.866-1.724,3.442-1.765h0.036h0.108c1.575,0.041,2.709,0.67,3.442,1.765 c1.354,2.105,1.026,5.681,0.62,7.449c-0.295,1.262-1.026,2.565-1.537,3.24c-0.4,0.505-0.547,0.757-0.585,1.137 c0,0.671,0.439,2.65,1.318,3.24c0.184,0.126,0.479,0.294,0.842,0.463c0.329,0.168,0.695,0.336,1.099,0.505 c0.548,0.251,1.17,0.504,1.757,0.756c0.987,0.422,2.451,1.053,2.671,1.221c0.438,0.337,0.771,0.715,1.062,1.683 c0.11,0.336,0.182,0.885,0.255,1.516c0.038,0.294,0.074,0.632,0.111,0.927c0.038,0.252,0.038,0.505,0.074,0.757 C176.713,43.461,174.369,44.64,166.099,44.64 M177.993,41.4c-0.073-0.673-0.182-1.389-0.33-1.808 c-0.364-1.179-0.805-1.726-1.391-2.146c-0.293-0.211-1.317-0.674-2.854-1.305c-0.293-0.125-0.586-0.252-0.842-0.378 c1.099-0.463,2.195-0.968,2.672-1.263c0.622-0.42,1.281-1.935,1.023-2.777c-0.071-0.21-0.219-0.42-0.401-0.673 c-0.404-0.505-0.916-1.473-1.134-2.398c-0.294-1.305-0.551-3.997,0.475-5.556c0.549-0.841,1.392-1.261,2.562-1.302h0.074 c1.169,0.042,2.012,0.461,2.56,1.302c1.025,1.56,0.769,4.251,0.476,5.556c-0.219,0.925-0.768,1.893-1.171,2.398 c-0.292,0.378-0.438,0.63-0.438,0.925c0,0.547,0.329,2.062,1.06,2.524c0.479,0.337,1.685,0.843,2.819,1.306 c0.696,0.293,1.867,0.798,2.015,0.925c0.328,0.251,0.548,0.547,0.768,1.22c0.111,0.378,0.218,1.264,0.291,2.313 C185.717,40.558,183.885,41.357,177.993,41.4 M186.997,40.685v-0.211c-0.038-0.631-0.146-2.146-0.366-2.818 c-0.293-0.926-0.657-1.348-1.099-1.682c-0.219-0.169-0.988-0.506-2.194-1.011c-1.025-0.42-2.271-0.969-2.709-1.263 c-0.33-0.211-0.621-1.304-0.657-1.684c0-0.042,0.072-0.126,0.255-0.337c0.476-0.589,1.099-1.726,1.354-2.818 c0.33-1.473,0.624-4.503-0.587-6.355c-0.694-1.05-1.756-1.64-3.182-1.683h-0.112h-0.036c-1.428,0.042-2.488,0.633-3.184,1.683 c-1.207,1.853-0.952,4.882-0.584,6.355c0.255,1.093,0.877,2.229,1.354,2.818c0.036,0.086,0.218,0.253,0.255,0.337 c0.111,0.338-0.329,1.472-0.657,1.684c-0.44,0.294-1.611,0.799-2.673,1.263h-0.038c-0.256,0.126-0.475,0.21-0.693,0.294 c-0.695-0.294-1.282-0.59-1.574-0.8c-0.513-0.336-0.915-1.892-0.915-2.355c0-0.042,0.036-0.127,0.327-0.505 c0.627-0.759,1.395-2.231,1.723-3.661c0.439-1.937,0.805-5.849-0.771-8.248c-0.877-1.388-2.268-2.103-4.099-2.146h-0.146h-0.037 c-1.83,0.083-3.219,0.8-4.1,2.187c-1.573,2.398-1.206,6.311-0.768,8.248c0.332,1.43,1.136,2.86,1.721,3.619 c0.073,0.126,0.293,0.378,0.327,0.505c0.147,0.505-0.438,2.019-0.912,2.355c-0.587,0.38-2.16,1.053-3.588,1.684 c-1.536,0.673-2.562,1.094-2.818,1.305c-0.549,0.421-1.026,0.968-1.39,2.146c-0.184,0.882-0.295,2.903-0.367,3.701v0.211 l0.145,0.168c0.405,0.461,2.49,1.936,11.898,1.936c9.333,0,11.458-1.515,11.895-1.979l0.146-0.168v-0.21 c0-0.251-0.035-0.545-0.072-0.925c6.844-0.041,8.455-1.179,8.784-1.515L186.997,40.685z"/> <text transform="matrix(1.0893 0 0 1 336.5811 40.542)" fill="#FFFFFF" font-family="HelveticaNeue-Bold" font-size="21.4719">45</text> <line fill="#00BDD1" x1="350.832" y1="12.28" x2="350.832" y2="18.988"/> <line fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" x1="350.832" y1="12.28" x2="350.832" y2="18.988"/> <line fill="#00BDD1" x1="343.524" y1="12.28" x2="343.524" y2="18.988"/> <line fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" x1="343.524" y1="12.28" x2="343.524" y2="18.988"/> <line fill="#00BDD1" x1="358.142" y1="12.28" x2="358.142" y2="18.988"/> <line fill="none" stroke="#FFFFFF" stroke-width="2" stroke-miterlimit="10" x1="358.142" y1="12.28" x2="358.142" y2="18.988"/> <path fill="#00BDD1" d="M333.22,682.496c-19.347,0-35.085-15.737-35.085-35.081c0-19.346,15.738-35.084,35.085-35.084 c19.343,0,35.082,15.738,35.082,35.084C368.302,666.759,352.562,682.496,333.22,682.496"/> <polygon fill="#FFFFFF" points="342.663,656.049 342.663,660.908 322.871,660.908 322.871,633.92 342.663,633.92 342.663,638.703 345.135,636.251 345.135,631.468 320.399,631.468 320.399,663.36 345.135,663.36 345.135,653.595 "/> <polygon fill="#FFFFFF" points="338.015,655.455 332.767,657.189 334.517,651.986 350.259,636.375 353.756,639.845 "/> <path fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" d="M222.443,22.797 c-0.442-2.665-2.703-4.419-5.049-3.918c-2.347,0.502-3.89,3.07-3.449,5.738c0.133,0.793,0.43,1.506,0.841,2.103 c0.041-0.019,0.088-0.038,0.136-0.053c0.2-0.133,0.442-0.215,0.733-0.215c0.011,0,0.021,0.001,0.03,0.002 c0.135-0.076,0.288-0.132,0.462-0.154c0.138-0.049,0.29-0.077,0.459-0.077c0.1,0,0.191,0.011,0.28,0.028 c0.091-0.017,0.186-0.028,0.285-0.028c0.07,0,0.137,0.005,0.201,0.014c0.053-0.007,0.108-0.014,0.166-0.014 c0.238,0,0.448,0.055,0.628,0.147c0.371,0.005,0.67,0.142,0.895,0.357c0.29,0.054,0.524,0.192,0.704,0.387 c0.406,0.066,0.708,0.298,0.905,0.611C222.019,26.654,222.769,24.755,222.443,22.797z"/> <ellipse fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" cx="217.022" cy="32.553" rx="5.534" ry="6.286"/> <path fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" d="M211.547,31.58 c-0.044-0.226,0.25-0.891,0.25-1.225c0.027-0.115,0.061-0.229,0.11-0.336c-0.578-1.445-1.967-2.316-3.404-2.007 c-1.689,0.361-2.8,2.211-2.484,4.129c0.32,1.919,1.948,3.183,3.637,2.82c0.771-0.166,1.411-0.646,1.859-1.299 c-0.041-0.172-0.056-0.35-0.053-0.528c0.041-0.452,0.041-0.784,0.064-1.448C211.529,31.652,211.541,31.617,211.547,31.58z"/> <path fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" d="M223.696,36.722 c-0.146-0.893-0.807-1.521-1.565-1.587c-0.033,0.103-0.072,0.203-0.123,0.298c-0.119,0.228-0.272,0.429-0.424,0.63 c0.233-0.307,0.011,0.008-0.026,0.083c-0.016,0.031-0.037,0.062-0.052,0.091c-0.023,0.047-0.046,0.091-0.074,0.132 c-0.123,0.225-0.254,0.447-0.411,0.643c-0.098,0.123-0.215,0.241-0.343,0.346c-0.086,0.135-0.193,0.252-0.317,0.35 c0.269,0.919,1.099,1.494,1.959,1.31C223.257,38.816,223.876,37.789,223.696,36.722z"/> <ellipse fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" cx="224.962" cy="27.801" rx="2.073" ry="2.357"/> <ellipse fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" cx="217.824" cy="44.217" rx="1.092" ry="1.24"/> <ellipse fill="none" stroke="#FFFFFF" stroke-width="0.8" stroke-miterlimit="10" cx="213.843" cy="41.76" rx="2.075" ry="2.358"/>'

var shell ="M103.286,209.917C46.334,209.917,0,162.833,0,104.961C0,47.086,46.335,0,103.286,0 c56.947,0,103.28,47.085,103.28,104.961C206.568,162.833,160.234,209.917,103.286,209.917"
var firstopen = "M177.312,57.854c-0.905,0-1.8-0.444-2.335-1.259c-15.686-23.91-41.769-38.44-69.78-38.87 c-1.536-0.027-2.768-1.292-2.745-2.835c0.029-1.539,1.091-2.899,2.836-2.749c29.862,0.463,57.656,15.936,74.357,41.391 c0.842,1.288,0.486,3.021-0.804,3.864C178.371,57.708,177.842,57.854,177.312,57.854"

var secondopen = "M191.907,99.393c-1.424,0-2.639-1.087-2.777-2.533c-0.962-10.346-3.748-20.397-8.253-29.876 c-0.665-1.39-0.069-3.054,1.32-3.721c1.381-0.66,3.056-0.073,3.716,1.322c4.799,10.069,7.75,20.758,8.774,31.762 c0.143,1.533-0.982,2.893-2.514,3.038C192.082,99.39,191.995,99.393,191.907,99.393"



var width = $( window ).width(),
    height =  $( window ).height(),
    BorderPadding = 15,
    padding = 1.5, // separation between same-color circles
    clusterPadding = 6, // separation between different-color circles
    maxRadius = 109;
var feedSize = {
    'width': 386 ,
    'height': 702
}
var n = 23, // total number of circles
    m_p = 8
    m = 4; // number of distinct clusters

var color = d3.scale.category10()
    .domain(d3.range(m));
colors= ["#50C4D5", "#24AB9D","#F05D58","#F9A339"]
// The largest node for each cluster.
var clusters = new Array(m);

var appmode = false;

var nodes = []
var circle, svg, force, drag;


DifferentSizes()
Start()
//AddNewsfeed()

function DifferentSizes(){
  appmode = false

  for (i = 0; i < m; i++) {
    for  (j = 1; j <= m_p; j++){
      var rad =j/2*18 + 5
      var p =  rad /maxRadius
      d = {cluster: i, radius: rad, prop: "scale("+ p+ "," + p+")", oldrad: 0, loc: j}
      nodes.push(d)
    }

    clusters[i] = d
  }

  // nodes = d3.range(n).map(function() {
  //   var i = Math.floor(Math.random() * m),
  //       r =  Math.sqrt((i + 1) / m * -Math.log(Math.random())) * maxRadius,
  //       p = r /maxRadius,
  //       d = {cluster: i, radius: r, prop: "scale("+ p+ "," + p+")", oldrad: 0};

  //   if (!clusters[i] || (r > clusters[i].radius)) clusters[i] = d;
  //   return d;
  // });
}

function SameSize(){
  nodes.forEach(function(d){
    d.radius = maxRadius/2
    d.prop = "scale(0.5,0.5)";

  })

  MainUpdate()
}

function Start(){

force = d3.layout.force()
    .nodes(nodes)
    .size([width, height])
    .gravity(0)
    .charge(0)
    .on("tick", tick)
    .start();


drag = force.drag()
//     .on("dragstart", dragstart);

svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);

  MainUpdate()
}

function AddNewsfeed(){

  svg.append("g")
    .attr("class", "newsfeed")
    .html(function(){return newsfeed})
    .attr("transform", function(){
      return "scale(1, 1), translate(" + (width/2 - feedSize.width/2 )+" ," + (height/2- feedSize.height/2 ) +")"
    })
}
function MainUpdate(){

  svg.selectAll(".node").remove()
circle = svg.selectAll("circle")
    .data(nodes)
  .enter()
    .append("g")
    .attr("class", function(d) { return "node cluster"+d.cluster +" loc"+d.loc })
    .attr("id" , function(d){ return "nodenum" + d.cluster +d.loc })

circle.append("path" )
    .attr("d", shell)
    .attr("fill",  function(d){return colors[d.cluster] })
    .attr("transform", function(d){return d.prop})
    .attr("class","shell")
    //.attr("transform", "scale(0.5,0.5)")

circle.append("path" )
    .attr("d", firstopen)
    .attr("transform", function(d){return d.prop})
    .attr("class", "firstopen")

circle.append("path" )
    .attr("d", secondopen)
    .attr("transform", function(d){return d.prop})
    .attr("class", "secondopen")


// d3.selectAll(".loc"+m_p)
//     .classed("fixed", function(d){
//       return d.fixed = true
//     })
//       if(d.cluster % 2){
//         d.x = maxRadius
//       }
//       else{
//         d.x = width - maxRadius*2
//       }
//       if(d.cluster % 3){
//           d.y = maxRadius
//       }
//       else{
//         d.y =  width - maxRadius*2

//       }
//       console.log(d.x +","+ d.y)
//       return d.fixed = true
//     });

    // var max = arr[0];
    // var maxIndex = 0;

//d3.select("#nodenum"+7).az
    circle//.attr("r", function(d) { return d.radius; })
    //.style("fill", function(d) { return color(d.cluster); })
    // .attr("transform", function(d){
    //   var size = d.radius/106
    //   console.log(d.prop)
    //   return "scale("+ size+ "," + size+"),"})
    .on("click", Openup)
    .call(drag);

    force.resume()


}


function Openup(d){
  if (d3.event.defaultPrevented) return; // click suppressed

  if (d.oldrad != 0){
    d.radius = d.oldrad
    d.oldrad = 0
  }
  else{
    d.oldrad = d.radius
    d.radius = 210
  }

  var p = d.radius/ maxRadius
  d.prop = "scale("+ p+ "," + p+")"
  d3.select("#nodenum" + d.cluster +d.loc).selectAll("path").attr("transform", function(d){return d.prop})
  force.resume()
}
// d3.select("body")
//     .on("mousedown", mousedown);

function mousedown() {
  circle.forEach(function(o, i) {
    o.x += (Math.random() - .5) * 1000;
    o.y += (Math.random() - .5) * 1000;
  });
  force.resume();
}
function tick(e) {
  circle
      .each(cluster(10 * e.alpha * e.alpha))
      .each(collide(.5))
      //.each(Corners(e.alpha))
      .each(collideEndSvg())
      //.each(collideNewsfeed())

      .attr("transform", function(d) {
        return "translate("+d.x+","+d.y+")";
      });
      // .attr("cx", function(d) { return d.x; })
      // .attr("cy", function(d) { return d.y; });
}

// Move d to be adjacent to the cluster node.
function cluster(alpha) {
  return function(d) {
    //if (d.fixed) return
    var cluster = clusters[d.cluster],
        k = 1;

    // For cluster nodes, apply custom gravity.
    if (cluster === d) {
      //var location = ;
      var x_move=  d.cluster & 1 ? width : -width;
      var y_move = d.cluster & 2 ? height : -height;
      cluster = {x: x_move, y: y_move, radius: -d.radius};
      k = .1 * Math.sqrt(d.radius);

    }

    var x = d.x - cluster.x,
        y = d.y - cluster.y,
        l = Math.sqrt(x * x + y * y),
        r = d.radius + cluster.radius;
    if (l != r) {
      l = (l - r) / l * alpha * k;
      d.x -= x *= l;
      d.y -= y *= l;
      cluster.x += x;
      cluster.y += y;
    }
  };
}

function Corners(alpha){

  return function(d){
    if(d.loc != 5 ) return
      d.fixed = true
      //console.log(alpha)
    var k = 30 * alpha;

    d.y += d.cluster & 1 ? k : -k;
    d.x += d.cluster & 2 ? 3*k : -3*k;
    //console.log(d.x + "," + d.y)
  }
}
function collideEndSvg(){
  return function(d){

    if ( d.x >  (width) - d.radius*2  - BorderPadding){
      d.x = (width) - d.radius*2 - BorderPadding
    }
    else if ( d.x < 0 + BorderPadding){
      d.x = 0 + BorderPadding
    }

    if ( d.y  <  0 + BorderPadding){
      d.y =  0 + BorderPadding
    }
    else if ( d.y > (height) - d.radius * 2  - BorderPadding){
      d.y = (height) - d.radius * 2 - BorderPadding
    }
  }
}
function collideNewsfeed(){
  return function(d){
    if (!appmode) return;
    if ( d.x >  (width/2 + feedSize.width/2) - d.radius*2 ){
      d.x =(width/2  + feedSize.width/2) - d.radius*2
    }
    else if ( d.x < (width/2 - feedSize.width/2 ) ){
      d.x =  (width/2 - feedSize.width/2 )
    }

    if ( d.y  < (height/2- feedSize.height/(2.4)) ){
      d.y = (height/2- feedSize.height/(2.4))
    }
    else if ( d.y > (height/2 + feedSize.height/2) - d.radius * 2){
      d.y = (height/2 + feedSize.height/2  ) - d.radius *2
    }
  }
}
// function dragstart(d) {
//   d3.select(this).classed("fixed", d.fixed = true);
// }
// Resolves collisions between d and all other circles.
function collide(alpha) {

  var quadtree = d3.geom.quadtree(nodes);
  return function(d) {
   if (d.fixed) return
    var r = d.radius + maxRadius + Math.max(padding, clusterPadding),
        nx1 = d.x - r,
        nx2 = d.x + r,
        ny1 = d.y - r,
        ny2 = d.y + r;
    quadtree.visit(function(quad, x1, y1, x2, y2) {
      if (quad.point && (quad.point !== d)) {
        var x = d.x - quad.point.x,
            y = d.y - quad.point.y,
            l = Math.sqrt(x * x + y * y),
            r = d.radius + quad.point.radius + (d.cluster === quad.point.cluster ? padding : clusterPadding);
        if (l < r) {
          l = (l - r) / l * alpha;
          d.x -= x *= l;
          d.y -= y *= l;
          quad.point.x += x;
          quad.point.y += y;
        }
      }
      return x1 > nx2 || x2 < nx1 || y1 > ny2 || y2 < ny1;
    });
  };
}

</script>